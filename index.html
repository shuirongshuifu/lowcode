<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/ico.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <title>低代码平台-lowcode</title>
  <style>
    .cropBox {
      position: absolute;
      top: 50px;
      left: 50px;
      width: 200px;
      height: 200px;
      border: 2px solid #67c23a;
      box-sizing: border-box;
      cursor: move;
      z-index: 9999;
    }

    .val {
      position: absolute;
      font-size: 12px;
      color: #333;
      top: 5px;
      left: 5px;
    }

    .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: #000;
      cursor: pointer;
    }

    .nw {
      top: -5px;
      left: -5px;
      cursor: nwse-resize;
    }

    .ne {
      top: -5px;
      right: -5px;
      cursor: nesw-resize;
    }

    .sw {
      bottom: -5px;
      left: -5px;
      cursor: nesw-resize;
    }

    .se {
      bottom: -5px;
      right: -5px;
      cursor: nwse-resize;
    }

    .content {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    img {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>

<body>
  <div class="cropBox" id="cropBox">
    <div class="resize-handle nw"></div>
    <div class="resize-handle ne"></div>
    <div class="resize-handle sw"></div>
    <div class="resize-handle se"></div>
    <span class="val">宽 200 高 200</span>
  </div>
  <div id="app"></div>

  <script type="module" src="/src/main.js"></script>
  <script>
    const cropBox = document.getElementById("cropBox");
    const val = cropBox.querySelector(".val");
    const content = document.getElementById("app");

    let isDragging = false;
    let isResizing = false;
    let startX, startY, startWidth, startHeight, startLeft, startTop, handleClass;

    const updateInfo = (width, height) => {
      val.textContent = `宽 ${Math.round(width)} 高 ${Math.round(height)}`;
    };

    // 开始拖拽或缩放
    cropBox.addEventListener("mousedown", (e) => {
      e.preventDefault();

      if (e.target.classList.contains("resize-handle")) {
        isResizing = true;
        handleClass = e.target.classList[1];
      } else {
        isDragging = true;
      }

      startX = e.clientX;
      startY = e.clientY;

      const rect = cropBox.getBoundingClientRect();
      startWidth = rect.width;
      startHeight = rect.height;
      startLeft = rect.left;
      startTop = rect.top;
    });

    document.addEventListener("mousemove", (e) => {
      if (isDragging) {
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        cropBox.style.left = `${startLeft + dx}px`;
        cropBox.style.top = `${startTop + dy}px`;
      }

      if (isResizing) {
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        let newWidth = startWidth;
        let newHeight = startHeight;
        let newLeft = startLeft;
        let newTop = startTop;

        switch (handleClass) {
          case "nw":
            newWidth = startWidth - dx;
            newHeight = startHeight - dy;
            newLeft = startLeft + dx;
            newTop = startTop + dy;
            break;
          case "ne":
            newWidth = startWidth + dx;
            newHeight = startHeight - dy;
            newTop = startTop + dy;
            break;
          case "sw":
            newWidth = startWidth - dx;
            newHeight = startHeight + dy;
            newLeft = startLeft + dx;
            break;
          case "se":
            newWidth = startWidth + dx;
            newHeight = startHeight + dy;
            break;
        }

        if (newWidth > 50) {
          cropBox.style.width = `${newWidth}px`;
          cropBox.style.left = `${newLeft}px`;
        }
        if (newHeight > 50) {
          cropBox.style.height = `${newHeight}px`;
          cropBox.style.top = `${newTop}px`;
        }

        updateInfo(newWidth, newHeight);
      }
    });

    document.addEventListener("mouseup", () => {
      isDragging = false;
      isResizing = false;
    });

    // 双击下载截图功能
    cropBox.addEventListener("dblclick", () => {
      const rect = cropBox.getBoundingClientRect();

      html2canvas(content).then((canvas) => {
        const croppedCanvas = document.createElement("canvas");
        const ctx = croppedCanvas.getContext("2d");

        const scale = window.devicePixelRatio;

        croppedCanvas.width = rect.width * scale;
        croppedCanvas.height = rect.height * scale;

        ctx.scale(scale, scale);

        ctx.drawImage(
          canvas,
          rect.left * scale,
          rect.top * scale,
          rect.width * scale,
          rect.height * scale,
          0,
          0,
          rect.width * scale,
          rect.height * scale
        );

        croppedCanvas.toBlob((blob) => {
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "screenshot.png";
          link.click();
        });
      });
    });
  </script>
</body>

</html>